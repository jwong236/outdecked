{% extends "base.html" %}

{% block title %}Search Cards - OutDecked{% endblock %}

{% block content %}
<style>
.filter-pill {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    margin: 2px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.and-filter {
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.or-filter {
    background-color: #f3e5f5;
    color: #7b1fa2;
    border: 1px solid #ce93d8;
}

.not-filter {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
}

.filter-pill .remove-btn {
    background: none;
    border: none;
    color: inherit;
    margin-left: 6px;
    padding: 0;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.filter-pill .remove-btn:hover {
    opacity: 1;
}

.filter-pill .remove-btn i {
    font-size: 0.75rem;
}

.filter-pill .type-indicator {
    font-weight: bold;
    font-size: 0.7rem;
    margin-right: 4px;
    opacity: 0.8;
}
</style>
<div class="main-container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-search text-primary me-3"></i>
                Search Cards
            </h1>
            
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Search Row -->
                    <form id="searchForm" class="row g-3">
                        <div class="col-md-10">
                            <label for="searchQuery" class="form-label">Search Cards</label>
                            <input type="text" class="form-control" id="searchQuery" name="q" 
                                   placeholder="Enter card name..." value="{{ query or '' }}" style="height: 38px;">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </form>
                    
                    <!-- Filter Row -->
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="gameFilter" class="form-label">Game</label>
                            <select class="form-select" id="gameFilter" name="game" style="height: 38px;">
                                <option value="">All Games</option>
                                <option value="Union Arena" selected>Union Arena</option>
                                <option value="Pokemon">Pokemon</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="animeFilter" class="form-label">Anime</label>
                            <select class="form-select" id="animeFilter" name="anime" style="height: 38px;">
                                <option value="">All Anime</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="colorFilter" class="form-label">Color</label>
                            <select class="form-select" id="colorFilter" name="color" style="height: 38px;">
                                <option value="">All Colors</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="sortBy" class="form-label">Sort By</label>
                            <select class="form-select" id="sortBy" name="sort" style="height: 38px;">
                                <option value="">Name (A-Z)</option>
                                <option value="price_desc">TCGP Price (High to Low)</option>
                                <option value="price_asc">TCGP Price (Low to High)</option>
                                <option value="rarity_desc">Rarity (High to Low)</option>
                                <option value="rarity_asc">Rarity (Low to High)</option>
                                <option value="number_desc">Number (High to Low)</option>
                                <option value="number_asc">Number (Low to High)</option>
                                <option value="cost_2_desc">Required Energy (High to Low)</option>
                                <option value="cost_2_asc">Required Energy (Low to High)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters Button -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showAdvancedFilters()">
                            <i class="fas fa-cog me-2"></i>Advanced Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Active Filters -->
            <div id="activeFilters" class="card mb-3">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <span class="text-muted small me-2">Active Filters:</span>
                        <div id="filterPills" class="d-flex flex-wrap gap-1">
                            <!-- Filter pills will be populated here -->
                        </div>
                        <button class="btn btn-outline-danger btn-sm ms-auto" onclick="clearAllFilters()">
                            <i class="fas fa-times me-1"></i>Clear All
                        </button>
                    </div>
                </div>
            </div>
            
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Searching cards...</p>
            </div>
            
            <!-- Results Grid -->
            <div id="resultsGrid" class="search-results" style="display: none;">
                <!-- Cards will be populated by JavaScript -->
            </div>
            
            <!-- Pagination Controls -->
            <div id="paginationControls" class="d-flex justify-content-center mt-4" style="display: none;">
                <nav aria-label="Search results pagination">
                    <ul class="pagination" id="paginationList">
                        <!-- Pagination buttons will be populated by JavaScript -->
                    </ul>
                </nav>
            </div>
            
            <!-- No Results State -->
            <div id="noResultsState" class="text-center py-5" style="display: none;">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No cards found</h4>
                <p class="text-muted">Try adjusting your search terms or game filter.</p>
            </div>
            
            <!-- Initial State -->
            <div id="initialState" class="text-center py-5">
                <i class="fas fa-search fa-3x text-primary mb-3"></i>
                <h4 class="text-muted">Start searching for cards</h4>
                <p class="text-muted">Enter a card name above to begin your search.</p>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Scrape Some Cards First
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filters Modal -->
<div class="modal fade" id="advancedFiltersModal" tabindex="-1" aria-labelledby="advancedFiltersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="advancedFiltersModalLabel">Advanced Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Advanced Filter Form -->
                <div class="mb-4">
                    <h6 class="text-primary">
                        <i class="fas fa-filter me-2"></i>Add Advanced Filter
                    </h6>
                    <div class="row g-2 mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="advancedFilterType" style="height: 38px;">
                                <option value="and">AND (All must match)</option>
                                <option value="or">OR (Any can match)</option>
                                <option value="not">NOT (Must NOT match)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="advancedFilterField" style="height: 38px;">
                                <option value="series">Series</option>
                                <option value="color">Color</option>
                                <option value="rarity">Rarity</option>
                                <option value="card_type">Card Type</option>
                                <option value="cost_2">Required Energy</option>
                                <option value="affinities">Affinities</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <select class="form-select" id="advancedFilterValue" style="height: 38px;">
                                <option value="">Select value...</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" onclick="addAdvancedFilter()" style="height: 38px;">
                            <i class="fas fa-plus me-2"></i>Add Filter
                        </button>
                    </div>
                </div>
                
                <!-- Quick Filter Buttons -->
                <div class="mb-3">
                    <h6 class="text-muted">Quick Filters:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-secondary" onclick="addQuickFilter('rarity', 'Rare')" style="height: 38px;">
                            <i class="fas fa-star me-1"></i>Rare
                        </button>
                        <button class="btn btn-outline-secondary" onclick="addQuickFilter('rarity', 'Common')" style="height: 38px;">
                            <i class="fas fa-circle me-1"></i>Common
                        </button>
                        <button class="btn btn-outline-secondary" onclick="addQuickFilter('card_type', 'Character')" style="height: 38px;">
                            <i class="fas fa-user me-1"></i>Character
                        </button>
                        <button class="btn btn-outline-danger" onclick="addQuickNotFilter('card_type', 'Action Point')" style="height: 38px;">
                            <i class="fas fa-ban me-1"></i>NOT Action Point
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Card Detail Modal -->
    <div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cardModalLabel">Card Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="text-center">
                                <img id="modalCardImage" src="" alt="" class="img-fluid rounded shadow" style="max-height: 500px; object-fit: contain; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h3 id="modalCardName" class="mb-4 text-primary"></h3>
                            
                            <!-- Dynamic Card Metadata Grid -->
                            <div id="modalCardMetadata" class="row g-3 mb-4">
                                <!-- Metadata fields will be dynamically populated here -->
                            </div>
                            
                            <!-- Card Text/Effect -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Effect:</h6>
                                <p id="modalCardText" class="mb-0" style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;"></p>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2">
                                <a id="modalCardUrl" href="#" target="_blank" class="btn btn-primary">
                                    <i class="fas fa-external-link-alt me-2"></i>View on TCGPlayer
                                </a>
                                <button id="modalAddToHandBtn" class="btn btn-success" onclick="addToHandFromModal()">
                                    <i class="fas fa-hand-paper me-2"></i>Add to Hand
                                </button>
                                <button class="btn btn-outline-secondary" onclick="downloadImage(document.getElementById('modalCardImage').src, document.getElementById('modalCardName').textContent)">
                                    <i class="fas fa-download me-2"></i>Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Arrows (Left and Right of Screen) -->
    <button type="button" class="btn btn-outline-primary position-fixed" id="prevCardBtn" onclick="navigateCard(-1)" style="display: none !important; left: 30px; top: 50%; transform: translateY(-50%); z-index: 1070; width: 50px; height: 80px; border-radius: 8px; background-color: rgba(255,255,255,0.9) !important; border: 2px solid #007bff; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        <i class="fas fa-chevron-left" style="color: #007bff; font-size: 18px;"></i>
    </button>
    <button type="button" class="btn btn-outline-primary position-fixed" id="nextCardBtn" onclick="navigateCard(1)" style="display: none !important; right: 30px; top: 50%; transform: translateY(-50%); z-index: 1070; width: 50px; height: 80px; border-radius: 8px; background-color: rgba(255,255,255,0.9) !important; border: 2px solid #007bff; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
        <i class="fas fa-chevron-right" style="color: #007bff; font-size: 18px;"></i>
    </button>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let currentQuery = '';
let currentGame = 'Union Arena'; // Default to Union Arena
let totalPages = 1;
let currentSearchResults = []; // Store current search results for navigation
let currentCardIndex = 0; // Track current card position in search results
let allSearchResults = []; // Store ALL search results across pages for seamless navigation
let isLoadingMoreResults = false; // Prevent multiple simultaneous requests
let activeFilters = {
    or: [], // OR filters (purple pills) - any one must match
    and: [], // AND filters (blue pills) - all must match
    not: [] // NOT filters (red pills) - must NOT match
};

document.addEventListener('DOMContentLoaded', function() {
    // Set up default Union Arena filter
    addFilter('and', 'game', 'Union Arena', 'Game: Union Arena');
    
    // Populate dropdowns
    populateAnimeDropdown();
    populateColorDropdown();
    
    // Handle form submission
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        currentQuery = document.getElementById('searchQuery').value.trim();
        currentPage = 1;
        performSearch();
    });
    
    // Handle filter changes - FIXED: Only add to active filters, don't trigger search
    document.getElementById('gameFilter').addEventListener('change', function() {
        const selectedGame = this.value;
        
        // Update the game filter in active filters
        activeFilters.and = activeFilters.and.filter(f => f.field !== 'game');
        if (selectedGame) {
            addFilter('and', 'game', selectedGame, `Game: ${selectedGame}`);
        }
        
        // Update main filters based on selected game
        updateMainFiltersForGame(selectedGame);
        
        // Don't trigger search here - let addFilter handle it
    });
    
    document.getElementById('animeFilter').addEventListener('change', function() {
        const selectedAnime = this.value;
        
        // Remove existing anime filter and add new one
        activeFilters.and = activeFilters.and.filter(f => f.field !== 'series');
        if (selectedAnime) {
            addFilter('and', 'series', selectedAnime, `Anime: ${selectedAnime}`);
        } else {
            // If no anime selected, trigger search to update results
            updateFilterDisplay();
            performSearch();
        }
    });
    
    document.getElementById('colorFilter').addEventListener('change', function() {
        const selectedColor = this.value;
        
        // Remove existing color filter and add new one
        activeFilters.and = activeFilters.and.filter(f => f.field !== 'color');
        if (selectedColor) {
            addFilter('and', 'color', selectedColor, `Color: ${selectedColor}`);
        } else {
            // If no color selected, trigger search to update results
            updateFilterDisplay();
            performSearch();
        }
    });
    
    document.getElementById('sortBy').addEventListener('change', function() {
        currentPage = 1;
        performSearch();
    });
    
    // Set up filter dropdown event listeners
    document.getElementById('advancedFilterField').addEventListener('change', function() {
        updateFilterValueDropdown('advancedFilterValue', this.value);
    });
    
    // Check if we have URL parameters for initial search
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('q');
    const gameParam = urlParams.get('game');
    
    if (queryParam || gameParam) {
        document.getElementById('searchQuery').value = queryParam || '';
        document.getElementById('gameFilter').value = gameParam || '';
        currentQuery = queryParam || '';
        
        // Update game filter if specified
        if (gameParam) {
            activeFilters.and = activeFilters.and.filter(f => f.field !== 'game');
            addFilter('and', 'game', gameParam, `Game: ${gameParam}`);
        }
        
        performSearch();
    } else {
        // If no URL parameters, show all cards by default
        performSearch();
    }
});


function performSearch() {
    // Show loading state
    showLoadingState();
    
    // Reset all search results for new search
    allSearchResults = [];
    isLoadingMoreResults = false;
    
    // Build search URL
    const params = new URLSearchParams();
    if (currentQuery) params.append('q', currentQuery);
    
    // FIXED: Only use active filters for filtering, not dropdown values
    // Dropdowns are only for adding filters to active filters
    const sortBy = document.getElementById('sortBy').value;
    if (sortBy) params.append('sort', sortBy);
    
    params.append('page', currentPage);
    
    // Add filters to the request - this is the ONLY source of filtering
    if (activeFilters.or.length > 0) {
        params.append('or_filters', JSON.stringify(activeFilters.or));
    }
    if (activeFilters.and.length > 0) {
        params.append('and_filters', JSON.stringify(activeFilters.and));
    }
    if (activeFilters.not.length > 0) {
        params.append('not_filters', JSON.stringify(activeFilters.not));
    }
    
    // Update URL without page reload
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.history.pushState({}, '', newUrl);
    
    // Perform search
    fetch(`/api/search?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            displayResults(data);
        })
        .catch(error => {
            console.error('Error searching cards:', error);
            showErrorState();
        });
}

// Populate anime dropdown
function populateAnimeDropdown() {
    fetch('/api/anime-values')
        .then(response => response.json())
        .then(animes => {
            const dropdown = document.getElementById('animeFilter');
            // Clear existing options except the first "All anime" option
            dropdown.innerHTML = '<option value="">All anime</option>';
            
            animes.forEach(anime => {
                const option = document.createElement('option');
                option.value = anime;
                option.textContent = anime;
                dropdown.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading anime values:', error);
        });
}

// Populate color dropdown
function populateColorDropdown() {
    fetch('/api/color-values')
        .then(response => response.json())
        .then(colors => {
            const dropdown = document.getElementById('colorFilter');
            // Clear existing options except the first "All colors" option
            dropdown.innerHTML = '<option value="">All colors</option>';
            
            colors.forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                dropdown.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading color values:', error);
        });
}

function displayResults(data) {
    const cards = data.cards;
    const pagination = data.pagination;
    
    // Store current search results for navigation
    currentSearchResults = cards;
    
    // Update all search results for seamless navigation
    if (currentPage === 1) {
        // First page - replace all results
        allSearchResults = cards;
    } else {
        // Subsequent pages - append to existing results
        allSearchResults = allSearchResults.concat(cards);
    }
    
    // Update pagination info
    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;
    
    // Hide all states
    hideAllStates();
    
    if (cards.length === 0) {
        showNoResultsState();
        return;
    }
    
    // Show results
    showResultsState();
    
    // Display cards
    displayCards(cards);
    
    // Update pagination controls
    updatePaginationControls(pagination);
}


function displayCards(cards) {
    const resultsGrid = document.getElementById('resultsGrid');
    
    let html = '';
    cards.forEach(card => {
        // Check if card is already in cart
        const cart = JSON.parse(sessionStorage.getItem('shoppingCart') || '[]');
        const existingCard = cart.find(c => c.card_url === card.card_url);
        
        let addToHandButton;
        if (existingCard) {
            const quantity = existingCard.quantity || 1;
            addToHandButton = `
                <button class="btn btn-success btn-sm flex-fill d-flex align-items-center justify-content-between" style="height: 38px; white-space: nowrap; padding: 0 8px;">
                    <i class="fas fa-minus" onclick="event.stopPropagation(); adjustGridQuantity('${card.card_url}', -1)" style="cursor: pointer; font-size: 14px; padding: 4px;"></i>
                    <span style="font-weight: bold; min-width: 20px; text-align: center;">${quantity}</span>
                    <i class="fas fa-plus" onclick="event.stopPropagation(); adjustGridQuantity('${card.card_url}', 1)" style="cursor: pointer; font-size: 14px; padding: 4px;"></i>
                </button>
            `;
        } else {
            addToHandButton = `
                <button class="btn btn-success btn-sm flex-fill" onclick="addToHand(${JSON.stringify(card).replace(/"/g, '&quot;')})" style="height: 38px; white-space: nowrap;">
                    <i class="fas fa-hand-paper me-1"></i>Add to Hand
                </button>
            `;
        }
        
        html += `
            <div class="card h-100">
                <div class="card-body p-0">
                    <img src="${card.image_url}" alt="${card.name}" class="card-image" style="cursor: pointer;" 
                         onclick="showCardModal(${JSON.stringify(card).replace(/"/g, '&quot;')})"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOGY4Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+'">
                </div>
                <div class="card-body">
                    <h6 class="card-title" title="${card.name}" style="line-height: 1.2; min-height: 1.2em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${card.name}</h6>
                    <p class="card-text small text-muted mb-2">${card.game}</p>
                    <div class="d-flex gap-2">
                        <a href="${card.card_url}" target="_blank" class="btn btn-primary btn-sm d-flex align-items-center justify-content-center" style="width: 80px; height: 38px;">
                            <img src="/static/tcg_icon.png" alt="TCG" style="width: 16px; height: 16px; margin-right: 4px;">
                            <span style="font-size: 0.8rem;">${card.price || 'NP'}</span>
                        </a>
                        ${addToHandButton}
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsGrid.innerHTML = html;
}

function updatePaginationControls(pagination) {
    const paginationList = document.getElementById('paginationList');
    
    if (totalPages <= 1) {
        document.getElementById('paginationControls').style.display = 'none';
        return;
    }
    
    document.getElementById('paginationControls').style.display = 'flex';
    
    let html = '';
    
    // Previous button
    if (pagination.has_prev) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${pagination.prev_page}); return false;">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
    } else {
        html += `
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-chevron-left"></i>
                </span>
            </li>
        `;
    }
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a></li>`;
        }
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    if (pagination.has_next) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${pagination.next_page}); return false;">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
    } else {
        html += `
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-chevron-right"></i>
                </span>
            </li>
        `;
    }
    
    paginationList.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    performSearch();
}

function showLoadingState() {
    hideAllStates();
    document.getElementById('loadingState').style.display = 'block';
}

function showResultsState() {
    hideAllStates();
    document.getElementById('resultsGrid').style.display = 'grid';
    document.getElementById('paginationControls').style.display = 'flex';
}

function showNoResultsState() {
    hideAllStates();
    document.getElementById('noResultsState').style.display = 'block';
}

function showErrorState() {
    hideAllStates();
    document.getElementById('noResultsState').style.display = 'block';
    document.getElementById('noResultsState').querySelector('h4').textContent = 'Error loading results';
    document.getElementById('noResultsState').querySelector('p').textContent = 'Please try again later.';
}

function hideAllStates() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultsGrid').style.display = 'none';
    document.getElementById('paginationControls').style.display = 'none';
    document.getElementById('noResultsState').style.display = 'none';
    document.getElementById('initialState').style.display = 'none';
}

// Shopping cart functionality
function addToHand(card) {
    // Get current cart from session storage
    let cart = JSON.parse(sessionStorage.getItem('shoppingCart') || '[]');
    
    // Check if card already exists in cart
    const existingCardIndex = cart.findIndex(c => c.card_url === card.card_url);
    
    if (existingCardIndex !== -1) {
        // Card already exists, increment quantity
        cart[existingCardIndex].quantity = (cart[existingCardIndex].quantity || 1) + 1;
    } else {
        // Add new card to cart
        card.quantity = 1;
        cart.push(card);
    }
    
    // Save back to session storage
    sessionStorage.setItem('shoppingCart', JSON.stringify(cart));
    
    // Show success message
    showCartNotification(`Added ${card.name} to hand!`);
    
    // Update cart count in navbar
    updateCartCount();
    
    // Update modal button if modal is open
    if (currentModalCard && currentModalCard.card_url === card.card_url) {
        updateModalAddToHandButton();
    }
    
    // Update the specific card's button state without refreshing the entire page
    updateCardButtonState(card.card_url);
}

// Add to Hand from modal
function addToHandFromModal() {
    if (currentModalCard) {
        addToHand(currentModalCard);
    }
}

// Update modal Add to Hand button state
function updateModalAddToHandButton() {
    if (!currentModalCard) return;
    
    const cart = JSON.parse(sessionStorage.getItem('shoppingCart') || '[]');
    const existingCard = cart.find(c => c.card_url === currentModalCard.card_url);
    const button = document.getElementById('modalAddToHandBtn');
    
    if (existingCard) {
        const quantity = existingCard.quantity || 1;
        button.innerHTML = `
            <i class="fas fa-minus" onclick="event.stopPropagation(); adjustModalQuantity(-1)" style="cursor: pointer; font-size: 14px; padding: 4px;"></i>
            <span style="font-weight: bold; min-width: 20px; text-align: center;">${quantity}</span>
            <i class="fas fa-plus" onclick="event.stopPropagation(); adjustModalQuantity(1)" style="cursor: pointer; font-size: 14px; padding: 4px;"></i>
        `;
        button.className = 'btn btn-success d-flex align-items-center justify-content-between';
        button.style.padding = '0 8px';
    } else {
        button.innerHTML = '<i class="fas fa-hand-paper me-2"></i>Add to Hand';
        button.className = 'btn btn-success';
    }
}

// Adjust quantity in modal
function adjustModalQuantity(change) {
    if (!currentModalCard) return;
    
    let cart = JSON.parse(sessionStorage.getItem('shoppingCart') || '[]');
    const existingCardIndex = cart.findIndex(c => c.card_url === currentModalCard.card_url);
    
    if (existingCardIndex !== -1) {
        const newQuantity = (cart[existingCardIndex].quantity || 1) + change;
        if (newQuantity <= 0) {
            // Remove from cart
            cart.splice(existingCardIndex, 1);
            showCartNotification(`Removed ${currentModalCard.name} from hand!`);
        } else {
            // Update quantity
            cart[existingCardIndex].quantity = newQuantity;
            showCartNotification(`Updated ${currentModalCard.name} quantity to ${newQuantity}!`);
        }
    }
    
    sessionStorage.setItem('shoppingCart', JSON.stringify(cart));
    updateCartCount();
    updateModalAddToHandButton();
}

// Adjust quantity in search grid
function adjustGridQuantity(cardUrl, change) {
    let cart = JSON.parse(sessionStorage.getItem('shoppingCart') || '[]');
    const existingCardIndex = cart.findIndex(c => c.card_url === cardUrl);
    
    if (existingCardIndex !== -1) {
        const card = cart[existingCardIndex];
        const newQuantity = (card.quantity || 1) + change;
        if (newQuantity <= 0) {
            // Remove from cart
            cart.splice(existingCardIndex, 1);
            showCartNotification(`Removed ${card.name} from hand!`);
        } else {
            // Update quantity
            cart[existingCardIndex].quantity = newQuantity;
            showCartNotification(`Updated ${card.name} quantity to ${newQuantity}!`);
        }
    }
    
    sessionStorage.setItem('shoppingCart', JSON.stringify(cart));
    updateCartCount();
    
    // Update the specific card's button state without refreshing the entire page
    updateCardButtonState(cardUrl);
}

// Update a specific card's button state without refreshing the entire page
function updateCardButtonState(cardUrl) {
    // Find the card in the current search results
    const card = allSearchResults.find(c => c.card_url === cardUrl);
    if (!card) return;
    
    // Find the card element in the DOM
    const cardElements = document.querySelectorAll('.card');
    let targetCardElement = null;
    
    for (let cardElement of cardElements) {
        const cardTitle = cardElement.querySelector('.card-title');
        if (cardTitle && cardTitle.textContent.trim() === card.name) {
            targetCardElement = cardElement;
            break;
        }
    }
    
    if (!targetCardElement) return;
    
    // Get the button container
    const buttonContainer = targetCardElement.querySelector('.d-flex.gap-2');
    if (!buttonContainer) return;
    
    // Get the current cart state
    const cart = JSON.parse(sessionStorage.getItem('shoppingCart') || '[]');
    const existingCard = cart.find(c => c.card_url === cardUrl);
    
    // Update the button
    const addToHandButton = buttonContainer.querySelector('button:last-child');
    if (addToHandButton) {
        if (existingCard) {
            const quantity = existingCard.quantity || 1;
            addToHandButton.innerHTML = `
                <i class="fas fa-minus" onclick="event.stopPropagation(); adjustGridQuantity('${cardUrl}', -1)" style="cursor: pointer; font-size: 14px; padding: 4px;"></i>
                <span style="font-weight: bold; min-width: 20px; text-align: center;">${quantity}</span>
                <i class="fas fa-plus" onclick="event.stopPropagation(); adjustGridQuantity('${cardUrl}', 1)" style="cursor: pointer; font-size: 14px; padding: 4px;"></i>
            `;
            addToHandButton.className = 'btn btn-success btn-sm flex-fill d-flex align-items-center justify-content-between';
            addToHandButton.style.cssText = 'height: 38px; white-space: nowrap; padding: 0 8px;';
        } else {
            addToHandButton.innerHTML = '<i class="fas fa-hand-paper me-1"></i>Add to Hand';
            addToHandButton.className = 'btn btn-success btn-sm flex-fill';
            addToHandButton.style.cssText = 'height: 38px; white-space: nowrap;';
            addToHandButton.onclick = () => addToHand(card);
        }
    }
}

function showCartNotification(message) {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.className = 'alert alert-success position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>${message}
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function updateCartCount() {
    const cart = JSON.parse(sessionStorage.getItem('shoppingCart') || '[]');
    const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
    
    // Update cart count in navbar
    const cartCountElement = document.getElementById('cartCount');
    if (cartCountElement) {
        cartCountElement.textContent = totalItems;
        cartCountElement.style.display = totalItems > 0 ? 'inline' : 'none';
    }
}

function downloadImage(imageUrl, cardName) {
    // Create a temporary link element
    const link = document.createElement('a');
    link.href = imageUrl;
    link.download = `${cardName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.jpg`;
    link.target = '_blank';
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Filter management functions
function addFilter(type, field, value, displayText) {
    const filter = { type, field, value, displayText };
    
    // Check if filter already exists
    const existingFilter = activeFilters[type].find(f => f.field === field && f.value === value);
    if (existingFilter) return;
    
    activeFilters[type].push(filter);
    updateFilterDisplay();
    performSearch();
}

function removeFilter(type, field, value) {
    activeFilters[type] = activeFilters[type].filter(f => !(f.field === field && f.value === value));
    
    // FIXED: Update dropdown state when filter is removed
    if (field === 'game') {
        document.getElementById('gameFilter').value = '';
    } else if (field === 'series') {
        document.getElementById('animeFilter').value = '';
    } else if (field === 'color') {
        document.getElementById('colorFilter').value = '';
    }
    
    updateFilterDisplay();
    performSearch();
}

function clearAllFilters() {
    // Preserve game filter only - clear all other filters
    const preservedFilters = activeFilters.and.filter(f => f.field === 'game');
    activeFilters.or = [];
    activeFilters.and = preservedFilters;
    activeFilters.not = [];
    
    // Reset dropdowns to default values
    document.getElementById('animeFilter').value = '';
    document.getElementById('colorFilter').value = '';
    document.getElementById('sortBy').value = '';
    
    updateFilterDisplay();
    performSearch();
}

function updateFilterDisplay() {
    const filterPills = document.getElementById('filterPills');
    const activeFiltersDiv = document.getElementById('activeFilters');
    
    // Clear existing pills
    filterPills.innerHTML = '';
    
    // Add OR filters first (they take priority)
    activeFilters.or.forEach(filter => {
        const pill = createFilterPill(filter, 'or');
        filterPills.appendChild(pill);
    });
    
    // Add AND filters
    activeFilters.and.forEach(filter => {
        const pill = createFilterPill(filter, 'and');
        filterPills.appendChild(pill);
    });
    
    // Add NOT filters
    activeFilters.not.forEach(filter => {
        const pill = createFilterPill(filter, 'not');
        filterPills.appendChild(pill);
    });
    
    // Show/hide the active filters section
    const hasFilters = activeFilters.or.length > 0 || activeFilters.and.length > 0 || activeFilters.not.length > 0;
    activeFiltersDiv.style.display = hasFilters ? 'block' : 'none';
}

function createFilterPill(filter, type) {
    const pill = document.createElement('div');
    pill.className = `filter-pill ${type}-filter`;
    
    // Add type indicator for all filter types
    const typeIndicator = type.toUpperCase();
    
    // Game filter should not be deletable
    const isGameFilter = filter.field === 'game';
    const removeButton = isGameFilter ? '' : `
        <button class="remove-btn" onclick="removeFilter('${type}', '${filter.field}', '${filter.value}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    pill.innerHTML = `
        <span class="type-indicator">${typeIndicator}</span>
        <span>${filter.displayText}</span>
        ${removeButton}
    `;
    return pill;
}

// Add click handlers to card elements for easy filtering
function addCardFilterHandlers() {
    // This will be called after cards are displayed
    // We can add click handlers to card elements to create filters
    // For example, clicking on a rarity could add a rarity filter
}

// Add filter from the filter panel
function addFilterFromPanel() {
    const filterType = document.getElementById('filterType').value;
    const filterField = document.getElementById('filterField').value;
    const filterValue = document.getElementById('filterValue').value.trim();
    
    if (!filterValue) {
        alert('Please enter a filter value');
        return;
    }
    
    // Create display text
    const fieldLabels = {
        'game': 'Game',
        'rarity': 'Rarity', 
        'series': 'Series',
        'card_type': 'Type'
    };
    
    const displayText = `${fieldLabels[filterField]}: ${filterValue}`;
    
    // Add the filter
    addFilter(filterType, filterField, filterValue, displayText);
    
    // Clear the input
    document.getElementById('filterValue').value = '';
}

// Add quick filter from buttons
function addQuickFilter(field, value) {
    const fieldLabels = {
        'game': 'Game',
        'rarity': 'Rarity', 
        'series': 'Series',
        'card_type': 'Type',
        'color': 'Color'
    };
    
    const displayText = `${fieldLabels[field]}: ${value}`;
    
    // Add as AND filter by default
    addFilter('and', field, value, displayText);
}

// Add quick NOT filter from buttons
function addQuickNotFilter(field, value) {
    const fieldLabels = {
        'game': 'Game',
        'rarity': 'Rarity', 
        'series': 'Series',
        'card_type': 'Type',
        'color': 'Color'
    };
    
    const displayText = `${fieldLabels[field]}: ${value}`;
    
    // Add as NOT filter
    addFilter('not', field, value, displayText);
}

// Show advanced filters modal
function showAdvancedFilters() {
    const modal = new bootstrap.Modal(document.getElementById('advancedFiltersModal'));
    modal.show();
}

// Update the value dropdown based on selected field
function updateFilterValueDropdown(dropdownId, field) {
    const dropdown = document.getElementById(dropdownId);
    
    // Clear existing options
    dropdown.innerHTML = '<option value="">Select value...</option>';
    
    if (!field) return;
    
    // Fetch values from API
    fetch(`/api/filter-values/${field}`)
        .then(response => response.json())
        .then(values => {
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                dropdown.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading filter values:', error);
        });
}

// Add advanced filter from modal
function addAdvancedFilter() {
    const type = document.getElementById('advancedFilterType').value;
    const field = document.getElementById('advancedFilterField').value;
    const value = document.getElementById('advancedFilterValue').value;
    
    if (!field || !value) {
        alert('Please select both a field and a value');
        return;
    }
    
    const fieldLabels = {
        'series': 'Anime',
        'color': 'Color',
        'rarity': 'Rarity', 
        'card_type': 'Card Type',
        'cost_2': 'Required Energy',
        'affinities': 'Affinities'
    };
    
    const displayText = `${fieldLabels[field]}: ${value}`;
    
    addFilter(type, field, value, displayText);
    
    // Reset the value dropdown
    document.getElementById('advancedFilterValue').value = '';
}

// Update main filters based on selected game
function updateMainFiltersForGame(game) {
    // Clear existing main filter dropdowns
    document.getElementById('animeFilter').innerHTML = '<option value="">All Anime</option>';
    document.getElementById('colorFilter').innerHTML = '<option value="">All Colors</option>';
    
    // Remove existing filters that are game-specific
    activeFilters.and = activeFilters.and.filter(f => f.field !== 'series' && f.field !== 'color');
    
    // Update filter labels and populate dropdowns based on game
    if (game === 'Union Arena') {
        document.querySelector('label[for="animeFilter"]').textContent = 'Anime';
        document.querySelector('label[for="colorFilter"]').textContent = 'Color';
        populateAnimeDropdown();
        populateColorDropdown();
    } else if (game === 'Pokemon') {
        document.querySelector('label[for="animeFilter"]').textContent = 'Type';
        document.querySelector('label[for="colorFilter"]').textContent = 'Stage';
        // For Pokemon, we would populate with Type and Stage values
        // But since we haven't scraped Pokemon yet, we'll leave them empty
    } else {
        // Hide main filters for unknown games
        document.querySelector('label[for="animeFilter"]').textContent = 'Filter 1';
        document.querySelector('label[for="colorFilter"]').textContent = 'Filter 2';
    }
    
    updateFilterDisplay();
}

// Store current card in modal for Add to Hand functionality
let currentModalCard = null;

// Card modal functions
function showCardModal(card) {
    // Store current card for modal operations
    currentModalCard = card;
    
    // Find the index of this card in all search results
    currentCardIndex = allSearchResults.findIndex(c => c.card_url === card.card_url);
    
    // Populate modal with card data
    document.getElementById('modalCardName').textContent = card.name;
    document.getElementById('modalCardImage').src = card.image_url;
    document.getElementById('modalCardImage').alt = card.name;
    document.getElementById('modalCardUrl').href = card.card_url;
    
    // Dynamically populate metadata fields based on what the card has
    populateDynamicMetadata(card);
    
    // Populate card text/effect
    document.getElementById('modalCardText').textContent = card.card_text || 'No effect text available.';
    
    // Update Add to Hand button state
    updateModalAddToHandButton();
    
    // Update navigation buttons
    updateNavigationButtons();
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('cardModal'));
    modal.show();
    
    // Show navigation arrows outside modal
    console.log('Showing navigation arrows...');
    document.getElementById('prevCardBtn').style.display = 'block';
    document.getElementById('nextCardBtn').style.display = 'block';
    console.log('Navigation arrows should be visible now');
    
    // Clean up any extra backdrops when modal is hidden
    document.getElementById('cardModal').addEventListener('hidden.bs.modal', function() {
        // Hide navigation arrows
        document.getElementById('prevCardBtn').style.display = 'none';
        document.getElementById('nextCardBtn').style.display = 'none';
        
        // Remove any extra backdrop elements
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Reset body class
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    });
}

// Navigate between cards in the modal with cross-page support (fixed)
function navigateCard(direction) {
    const newIndex = currentCardIndex + direction;
    
    // Check if we need to load more results
    if (newIndex >= allSearchResults.length && direction > 0 && currentPage < totalPages && !isLoadingMoreResults) {
        // Set the target index for after loading
        const targetIndex = newIndex;
        // Load next page and navigate to the target index
        loadNextPage(targetIndex);
        return;
    }
    
    // Check bounds for all search results
    if (newIndex >= 0 && newIndex < allSearchResults.length) {
        currentCardIndex = newIndex;
        const card = allSearchResults[currentCardIndex];
        
        // Update the modal content without reopening it
        updateModalContent(card);
        
        // Update navigation buttons
        updateNavigationButtons();
    }
}

// Load next page of results for seamless navigation (fixed)
function loadNextPage(targetIndex = null) {
    if (isLoadingMoreResults || currentPage >= totalPages) {
        return;
    }
    
    isLoadingMoreResults = true;
    
    // Build search URL for next page
    const params = new URLSearchParams();
    if (currentQuery) params.append('q', currentQuery);
    
    const sortBy = document.getElementById('sortBy').value;
    if (sortBy) params.append('sort', sortBy);
    
    params.append('page', currentPage + 1);
    
    // Add filters to the request
    if (activeFilters.or.length > 0) {
        params.append('or_filters', JSON.stringify(activeFilters.or));
    }
    if (activeFilters.and.length > 0) {
        params.append('and_filters', JSON.stringify(activeFilters.and));
    }
    if (activeFilters.not.length > 0) {
        params.append('not_filters', JSON.stringify(activeFilters.not));
    }
    
    // Load next page with timeout
    const timeoutId = setTimeout(() => {
        console.error('Timeout loading next page');
        isLoadingMoreResults = false;
        updateNavigationButtons();
    }, 10000); // 10 second timeout
    
    fetch(`/api/search?${params.toString()}`)
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const newCards = data.cards;
            const pagination = data.pagination;
            
            
            // Append new cards to all search results
            allSearchResults = allSearchResults.concat(newCards);
            
            // Update pagination info
            currentPage = pagination.current_page;
            totalPages = pagination.total_pages;
            
            // Navigate to the target index if provided, otherwise stay at current position
            if (targetIndex !== null && targetIndex < allSearchResults.length) {
                currentCardIndex = targetIndex;
            }
            
            const card = allSearchResults[currentCardIndex];
            updateModalContent(card);
            
            isLoadingMoreResults = false;
            updateNavigationButtons();
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error loading next page:', error);
            isLoadingMoreResults = false;
            updateNavigationButtons();
        });
}

// Update modal content without reopening the modal
function updateModalContent(card) {
    // Update current modal card
    currentModalCard = card;
    
    // Populate modal with card data
    document.getElementById('modalCardName').textContent = card.name;
    document.getElementById('modalCardImage').src = card.image_url;
    document.getElementById('modalCardImage').alt = card.name;
    document.getElementById('modalCardUrl').href = card.card_url;
    
    // Dynamically populate metadata fields based on what the card has
    populateDynamicMetadata(card);
    
    // Populate card text/effect
    document.getElementById('modalCardText').textContent = card.card_text || 'No effect text available.';
    
    // Update Add to Hand button state
    updateModalAddToHandButton();
    
    // Update navigation buttons
    updateNavigationButtons();
}

// Update navigation button states
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevCardBtn');
    const nextBtn = document.getElementById('nextCardBtn');
    
    
    // Hide buttons if there's only one card or no cards
    if (allSearchResults.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        return;
    }
    
    // Show buttons if there are multiple cards
    prevBtn.style.display = 'inline-block';
    nextBtn.style.display = 'inline-block';
    
    // Disable buttons at the edges
    prevBtn.disabled = currentCardIndex <= 0;
    
    // For next button, check if we're at the end of all results OR if we can load more pages
    const isAtEnd = currentCardIndex >= allSearchResults.length - 1;
    const canLoadMore = currentPage < totalPages && !isLoadingMoreResults;
    
    // Show loading state on next button if loading more results
    if (isLoadingMoreResults) {
        nextBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        nextBtn.disabled = true;
    } else {
        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextBtn.disabled = isAtEnd && !canLoadMore;
    }
    
    // Reset prev button content
    prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
}

// Populate dynamic metadata fields
function populateDynamicMetadata(card) {
    const metadataContainer = document.getElementById('modalCardMetadata');
    metadataContainer.innerHTML = '';
    
    // Define field mappings with display names
    const fieldMappings = {
        'rarity': 'Rarity',
        'card_number': 'Number',
        'series': 'Series Name',
        'card_type': 'Card Type',
        'color': 'Activation Energy',
        'cost_2': 'Required Energy',
        'cost_1': 'Action Point Cost',
        'battle_points': 'Battle Point (BP)',
        'special_ability': 'Trigger',
        'affinities': 'Affinities',
        'generated_energy': 'Generated Energy',
        'price': 'TCGP Price'
    };
    
    // Show fields that have values, or always show price field
    Object.entries(fieldMappings).forEach(([field, displayName]) => {
        const value = card[field];
        const shouldShow = (value && value !== '-' && value.trim() !== '') || field === 'price';
        
        if (shouldShow) {
            // Special handling for price field - show "NP" if empty
            const displayValue = field === 'price' && (!value || value.trim() === '') ? 'NP' : value;
            const fieldHtml = `
                <div class="col-md-6">
                    <div class="card border-0 bg-light">
                        <div class="card-body p-3">
                            <h6 class="card-title text-muted mb-1">${displayName}</h6>
                            <p class="card-text fw-bold mb-0 ${field === 'price' ? 'text-success' : ''}">${displayValue}</p>
                        </div>
                    </div>
                </div>
            `;
            metadataContainer.innerHTML += fieldHtml;
        }
    });
}
</script>
{% endblock %}