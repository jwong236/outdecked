{% extends "base.html" %}

{% block title %}Search Cards - TopDeck{% endblock %}

{% block content %}
<style>
.filter-pill {
    display: inline-flex;
    align-items: center;
    padding: 4px 8px;
    margin: 2px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.and-filter {
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.or-filter {
    background-color: #f3e5f5;
    color: #7b1fa2;
    border: 1px solid #ce93d8;
}

.not-filter {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
}

.filter-pill .remove-btn {
    background: none;
    border: none;
    color: inherit;
    margin-left: 6px;
    padding: 0;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s;
}

.filter-pill .remove-btn:hover {
    opacity: 1;
}

.filter-pill .remove-btn i {
    font-size: 0.75rem;
}
</style>
<div class="main-container">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-search text-primary me-3"></i>
                Search Cards
            </h1>
            
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Search Row -->
                    <form id="searchForm" class="row g-3">
                        <div class="col-md-10">
                            <label for="searchQuery" class="form-label">Search Cards</label>
                            <input type="text" class="form-control" id="searchQuery" name="q" 
                                   placeholder="Enter card name..." value="{{ query or '' }}" style="height: 38px;">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>Search
                            </button>
                        </div>
                    </form>
                    
                    <!-- Filter Row -->
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="gameFilter" class="form-label">Game</label>
                            <select class="form-select" id="gameFilter" name="game" style="height: 38px;">
                                <option value="">All Games</option>
                                <option value="Union Arena" selected>Union Arena</option>
                                <option value="Pokemon">Pokemon</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="animeFilter" class="form-label">Anime</label>
                            <select class="form-select" id="animeFilter" name="anime" style="height: 38px;">
                                <option value="">All Anime</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="colorFilter" class="form-label">Color</label>
                            <select class="form-select" id="colorFilter" name="color" style="height: 38px;">
                                <option value="">All Colors</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="sortBy" class="form-label">Sort By</label>
                            <select class="form-select" id="sortBy" name="sort" style="height: 38px;">
                                <option value="">Name (A-Z)</option>
                                <option value="price_desc">TCGP Price (High to Low)</option>
                                <option value="price_asc">TCGP Price (Low to High)</option>
                                <option value="rarity_desc">Rarity (High to Low)</option>
                                <option value="rarity_asc">Rarity (Low to High)</option>
                                <option value="number_desc">Number (High to Low)</option>
                                <option value="number_asc">Number (Low to High)</option>
                                <option value="cost_2_desc">Required Energy (High to Low)</option>
                                <option value="cost_2_asc">Required Energy (Low to High)</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters Button -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showAdvancedFilters()">
                            <i class="fas fa-cog me-2"></i>Advanced Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Active Filters -->
            <div id="activeFilters" class="card mb-3" style="display: none;">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <span class="text-muted small me-2">Active Filters:</span>
                        <div id="filterPills" class="d-flex flex-wrap gap-1">
                            <!-- Filter pills will be populated here -->
                        </div>
                        <button class="btn btn-outline-danger btn-sm ms-auto" onclick="clearAllFilters()">
                            <i class="fas fa-times me-1"></i>Clear All
                        </button>
                    </div>
                </div>
            </div>
            
            
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-5" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Searching cards...</p>
            </div>
            
            <!-- Results Grid -->
            <div id="resultsGrid" class="search-results" style="display: none;">
                <!-- Cards will be populated by JavaScript -->
            </div>
            
            <!-- Pagination Controls -->
            <div id="paginationControls" class="d-flex justify-content-center mt-4" style="display: none;">
                <nav aria-label="Search results pagination">
                    <ul class="pagination" id="paginationList">
                        <!-- Pagination buttons will be populated by JavaScript -->
                    </ul>
                </nav>
            </div>
            
            <!-- No Results State -->
            <div id="noResultsState" class="text-center py-5" style="display: none;">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No cards found</h4>
                <p class="text-muted">Try adjusting your search terms or game filter.</p>
            </div>
            
            <!-- Initial State -->
            <div id="initialState" class="text-center py-5">
                <i class="fas fa-search fa-3x text-primary mb-3"></i>
                <h4 class="text-muted">Start searching for cards</h4>
                <p class="text-muted">Enter a card name above to begin your search.</p>
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-download me-2"></i>Scrape Some Cards First
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Filters Modal -->
<div class="modal fade" id="advancedFiltersModal" tabindex="-1" aria-labelledby="advancedFiltersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="advancedFiltersModalLabel">Advanced Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Advanced Filter Form -->
                <div class="mb-4">
                    <h6 class="text-primary">
                        <i class="fas fa-filter me-2"></i>Add Advanced Filter
                    </h6>
                    <div class="row g-2 mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="advancedFilterType" style="height: 38px;">
                                <option value="and">AND (All must match)</option>
                                <option value="or">OR (Any can match)</option>
                                <option value="not">NOT (Must NOT match)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="advancedFilterField" style="height: 38px;">
                                <option value="series">Series</option>
                                <option value="color">Color</option>
                                <option value="rarity">Rarity</option>
                                <option value="card_type">Card Type</option>
                                <option value="cost_2">Required Energy</option>
                                <option value="affinities">Affinities</option>
                                <option value="language">Language</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <select class="form-select" id="advancedFilterValue" style="height: 38px;">
                                <option value="">Select value...</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" onclick="addAdvancedFilter()" style="height: 38px;">
                            <i class="fas fa-plus me-2"></i>Add Filter
                        </button>
                    </div>
                </div>
                
                <!-- Quick Filter Buttons -->
                <div class="mb-3">
                    <h6 class="text-muted">Quick Filters:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-secondary" onclick="addQuickFilter('rarity', 'Rare')" style="height: 38px;">
                            <i class="fas fa-star me-1"></i>Rare
                        </button>
                        <button class="btn btn-outline-secondary" onclick="addQuickFilter('rarity', 'Common')" style="height: 38px;">
                            <i class="fas fa-circle me-1"></i>Common
                        </button>
                        <button class="btn btn-outline-secondary" onclick="addQuickFilter('card_type', 'Character')" style="height: 38px;">
                            <i class="fas fa-user me-1"></i>Character
                        </button>
                        <button class="btn btn-outline-secondary" onclick="addQuickFilter('language', 'English')" style="height: 38px;">
                            <i class="fas fa-globe me-1"></i>English
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

    <!-- Card Detail Modal -->
    <div class="modal fade" id="cardModal" tabindex="-1" aria-labelledby="cardModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cardModalLabel">Card Details</h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="prevCardBtn" onclick="navigateCard(-1)">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="nextCardBtn" onclick="navigateCard(1)">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="text-center">
                                <img id="modalCardImage" src="" alt="" class="img-fluid rounded shadow" style="max-height: 500px; object-fit: contain; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
                            </div>
                        </div>
                        <div class="col-md-7">
                            <h3 id="modalCardName" class="mb-4 text-primary"></h3>
                            
                            <!-- Dynamic Card Metadata Grid -->
                            <div id="modalCardMetadata" class="row g-3 mb-4">
                                <!-- Metadata fields will be dynamically populated here -->
                            </div>
                            
                            <!-- Card Text/Effect -->
                            <div class="mb-3">
                                <h6 class="text-muted mb-2">Effect:</h6>
                                <p id="modalCardText" class="mb-0" style="white-space: pre-wrap; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff;"></p>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex gap-2">
                                <a id="modalCardUrl" href="#" target="_blank" class="btn btn-primary">
                                    <i class="fas fa-external-link-alt me-2"></i>View on TCGPlayer
                                </a>
                                <button class="btn btn-outline-secondary" onclick="downloadImage(document.getElementById('modalCardImage').src, document.getElementById('modalCardName').textContent)">
                                    <i class="fas fa-download me-2"></i>Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
let currentQuery = '';
let currentGame = 'Union Arena'; // Default to Union Arena
let totalPages = 1;
let currentSearchResults = []; // Store current search results for navigation
let currentCardIndex = 0; // Track current card position in search results
let activeFilters = {
    or: [], // OR filters (purple pills) - any one must match
    and: [], // AND filters (blue pills) - all must match
    not: [] // NOT filters (red pills) - must NOT match
};

document.addEventListener('DOMContentLoaded', function() {
    // Set up default Union Arena filter
    addFilter('and', 'game', 'Union Arena', 'Game: Union Arena');
    
    // Populate dropdowns
    populateAnimeDropdown();
    populateColorDropdown();
    
    // Handle form submission
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        currentQuery = document.getElementById('searchQuery').value.trim();
        currentPage = 1;
        performSearch();
    });
    
    // Handle filter changes
    document.getElementById('gameFilter').addEventListener('change', function() {
        const selectedGame = this.value;
        
        // Update the game filter in active filters
        activeFilters.and = activeFilters.and.filter(f => f.field !== 'game');
        if (selectedGame) {
            addFilter('and', 'game', selectedGame, `Game: ${selectedGame}`);
        }
        
        // Update main filters based on selected game
        updateMainFiltersForGame(selectedGame);
        
        currentPage = 1;
        performSearch();
    });
    
    document.getElementById('animeFilter').addEventListener('change', function() {
        const selectedAnime = this.value;
        
        // Remove existing anime filter and add new one
        activeFilters.and = activeFilters.and.filter(f => f.field !== 'series');
        if (selectedAnime) {
            addFilter('and', 'series', selectedAnime, `Anime: ${selectedAnime}`);
        }
        
        // Update the filter display
        updateFilterDisplay();
        
        currentPage = 1;
        performSearch();
    });
    
    document.getElementById('colorFilter').addEventListener('change', function() {
        const selectedColor = this.value;
        
        // Remove existing color filter and add new one
        activeFilters.and = activeFilters.and.filter(f => f.field !== 'color');
        if (selectedColor) {
            addFilter('and', 'color', selectedColor, `Color: ${selectedColor}`);
        }
        
        // Update the filter display
        updateFilterDisplay();
        
        currentPage = 1;
        performSearch();
    });
    
    document.getElementById('sortBy').addEventListener('change', function() {
        currentPage = 1;
        performSearch();
    });
    
    // Set up filter dropdown event listeners
    document.getElementById('advancedFilterField').addEventListener('change', function() {
        updateFilterValueDropdown('advancedFilterValue', this.value);
    });
    
    // Check if we have URL parameters for initial search
    const urlParams = new URLSearchParams(window.location.search);
    const queryParam = urlParams.get('q');
    const gameParam = urlParams.get('game');
    
    if (queryParam || gameParam) {
        document.getElementById('searchQuery').value = queryParam || '';
        document.getElementById('gameFilter').value = gameParam || '';
        currentQuery = queryParam || '';
        
        // Update game filter if specified
        if (gameParam) {
            activeFilters.and = activeFilters.and.filter(f => f.field !== 'game');
            addFilter('and', 'game', gameParam, `Game: ${gameParam}`);
        }
        
        performSearch();
    } else {
        // If no URL parameters, show all cards by default
        performSearch();
    }
});


function performSearch() {
    // Show loading state
    showLoadingState();
    
    // Build search URL
    const params = new URLSearchParams();
    if (currentQuery) params.append('q', currentQuery);
    
    // Add filter values
    const gameFilter = document.getElementById('gameFilter').value;
    const animeFilter = document.getElementById('animeFilter').value;
    const colorFilter = document.getElementById('colorFilter').value;
    const sortBy = document.getElementById('sortBy').value;
    
    if (gameFilter) params.append('game', gameFilter);
    if (animeFilter) params.append('anime', animeFilter);
    if (colorFilter) params.append('color', colorFilter);
    if (sortBy) params.append('sort', sortBy);
    
    params.append('page', currentPage);
    
    // Add filters to the request
    if (activeFilters.or.length > 0) {
        params.append('or_filters', JSON.stringify(activeFilters.or));
    }
    if (activeFilters.and.length > 0) {
        params.append('and_filters', JSON.stringify(activeFilters.and));
    }
    if (activeFilters.not.length > 0) {
        params.append('not_filters', JSON.stringify(activeFilters.not));
    }
    
    // Update URL without page reload
    const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    window.history.pushState({}, '', newUrl);
    
    // Perform search
    fetch(`/api/search?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            displayResults(data);
        })
        .catch(error => {
            console.error('Error searching cards:', error);
            showErrorState();
        });
}

// Populate anime dropdown
function populateAnimeDropdown() {
    fetch('/api/anime-values')
        .then(response => response.json())
        .then(animes => {
            const dropdown = document.getElementById('animeFilter');
            // Clear existing options except the first "All anime" option
            dropdown.innerHTML = '<option value="">All anime</option>';
            
            animes.forEach(anime => {
                const option = document.createElement('option');
                option.value = anime;
                option.textContent = anime;
                dropdown.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading anime values:', error);
        });
}

// Populate color dropdown
function populateColorDropdown() {
    fetch('/api/color-values')
        .then(response => response.json())
        .then(colors => {
            const dropdown = document.getElementById('colorFilter');
            // Clear existing options except the first "All colors" option
            dropdown.innerHTML = '<option value="">All colors</option>';
            
            colors.forEach(color => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                dropdown.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading color values:', error);
        });
}

function displayResults(data) {
    const cards = data.cards;
    const pagination = data.pagination;
    
    // Store current search results for navigation
    currentSearchResults = cards;
    
    // Update pagination info
    currentPage = pagination.current_page;
    totalPages = pagination.total_pages;
    
    // Hide all states
    hideAllStates();
    
    if (cards.length === 0) {
        showNoResultsState();
        return;
    }
    
    // Show results
    showResultsState();
    
    // Display cards
    displayCards(cards);
    
    // Update pagination controls
    updatePaginationControls(pagination);
}


function displayCards(cards) {
    const resultsGrid = document.getElementById('resultsGrid');
    
    let html = '';
    cards.forEach(card => {
        html += `
            <div class="card h-100">
                <div class="card-body p-0">
                    <img src="${card.image_url}" alt="${card.name}" class="card-image" style="cursor: pointer;" 
                         onclick="showCardModal(${JSON.stringify(card).replace(/"/g, '&quot;')})"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmOGY4Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OTk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+'">
                </div>
                <div class="card-body">
                    <h6 class="card-title" title="${card.name}" style="line-height: 1.2; min-height: 1.2em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${card.name}</h6>
                    <p class="card-text small text-muted mb-2">${card.game}</p>
                    <div class="d-flex gap-2">
                        <a href="${card.card_url}" target="_blank" class="btn btn-outline-primary btn-sm flex-fill">
                            <i class="fas fa-external-link-alt me-1"></i>TCGP
                        </a>
                        <button class="btn btn-success btn-sm flex-fill" onclick="downloadImage('${card.image_url}', '${card.name}')">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                    </div>
                    ${card.price ? `<div class="mt-2"><span class="badge bg-success">${card.price}</span></div>` : ''}
                </div>
            </div>
        `;
    });
    
    resultsGrid.innerHTML = html;
}

function updatePaginationControls(pagination) {
    const paginationList = document.getElementById('paginationList');
    
    if (totalPages <= 1) {
        document.getElementById('paginationControls').style.display = 'none';
        return;
    }
    
    document.getElementById('paginationControls').style.display = 'flex';
    
    let html = '';
    
    // Previous button
    if (pagination.has_prev) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${pagination.prev_page}); return false;">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
    } else {
        html += `
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-chevron-left"></i>
                </span>
            </li>
        `;
    }
    
    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(1); return false;">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a></li>`;
        }
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a></li>`;
    }
    
    // Next button
    if (pagination.has_next) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToPage(${pagination.next_page}); return false;">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
    } else {
        html += `
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="fas fa-chevron-right"></i>
                </span>
            </li>
        `;
    }
    
    paginationList.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    performSearch();
}

function showLoadingState() {
    hideAllStates();
    document.getElementById('loadingState').style.display = 'block';
}

function showResultsState() {
    hideAllStates();
    document.getElementById('resultsGrid').style.display = 'grid';
    document.getElementById('paginationControls').style.display = 'flex';
}

function showNoResultsState() {
    hideAllStates();
    document.getElementById('noResultsState').style.display = 'block';
}

function showErrorState() {
    hideAllStates();
    document.getElementById('noResultsState').style.display = 'block';
    document.getElementById('noResultsState').querySelector('h4').textContent = 'Error loading results';
    document.getElementById('noResultsState').querySelector('p').textContent = 'Please try again later.';
}

function hideAllStates() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('resultsGrid').style.display = 'none';
    document.getElementById('paginationControls').style.display = 'none';
    document.getElementById('noResultsState').style.display = 'none';
    document.getElementById('initialState').style.display = 'none';
}

function downloadImage(imageUrl, cardName) {
    // Create a temporary link element
    const link = document.createElement('a');
    link.href = imageUrl;
    link.download = `${cardName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.jpg`;
    link.target = '_blank';
    
    // Trigger download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Filter management functions
function addFilter(type, field, value, displayText) {
    const filter = { type, field, value, displayText };
    
    // Check if filter already exists
    const existingFilter = activeFilters[type].find(f => f.field === field && f.value === value);
    if (existingFilter) return;
    
    activeFilters[type].push(filter);
    updateFilterDisplay();
    performSearch();
}

function removeFilter(type, field, value) {
    activeFilters[type] = activeFilters[type].filter(f => !(f.field === field && f.value === value));
    updateFilterDisplay();
    performSearch();
}

function clearAllFilters() {
    // Preserve game filter only - clear all other filters
    const preservedFilters = activeFilters.and.filter(f => f.field === 'game');
    activeFilters.or = [];
    activeFilters.and = preservedFilters;
    activeFilters.not = [];
    
    // Reset dropdowns to default values
    document.getElementById('animeFilter').value = '';
    document.getElementById('colorFilter').value = '';
    document.getElementById('sortBy').value = '';
    
    updateFilterDisplay();
    performSearch();
}

function updateFilterDisplay() {
    const filterPills = document.getElementById('filterPills');
    const activeFiltersDiv = document.getElementById('activeFilters');
    
    // Clear existing pills
    filterPills.innerHTML = '';
    
    // Add OR filters first (they take priority)
    activeFilters.or.forEach(filter => {
        const pill = createFilterPill(filter, 'or');
        filterPills.appendChild(pill);
    });
    
    // Add AND filters
    activeFilters.and.forEach(filter => {
        const pill = createFilterPill(filter, 'and');
        filterPills.appendChild(pill);
    });
    
    // Add NOT filters
    activeFilters.not.forEach(filter => {
        const pill = createFilterPill(filter, 'not');
        filterPills.appendChild(pill);
    });
    
    // Show/hide the active filters section
    const hasFilters = activeFilters.or.length > 0 || activeFilters.and.length > 0 || activeFilters.not.length > 0;
    activeFiltersDiv.style.display = hasFilters ? 'block' : 'none';
}

function createFilterPill(filter, type) {
    const pill = document.createElement('div');
    pill.className = `filter-pill ${type}-filter`;
    
    // Game filter should not be deletable
    const isGameFilter = filter.field === 'game';
    const removeButton = isGameFilter ? '' : `
        <button class="remove-btn" onclick="removeFilter('${type}', '${filter.field}', '${filter.value}')">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    pill.innerHTML = `
        <span>${filter.displayText}</span>
        ${removeButton}
    `;
    return pill;
}

// Add click handlers to card elements for easy filtering
function addCardFilterHandlers() {
    // This will be called after cards are displayed
    // We can add click handlers to card elements to create filters
    // For example, clicking on a rarity could add a rarity filter
}

// Add filter from the filter panel
function addFilterFromPanel() {
    const filterType = document.getElementById('filterType').value;
    const filterField = document.getElementById('filterField').value;
    const filterValue = document.getElementById('filterValue').value.trim();
    
    if (!filterValue) {
        alert('Please enter a filter value');
        return;
    }
    
    // Create display text
    const fieldLabels = {
        'game': 'Game',
        'rarity': 'Rarity', 
        'series': 'Series',
        'card_type': 'Type',
        'language': 'Language'
    };
    
    const displayText = `${fieldLabels[filterField]}: ${filterValue}`;
    
    // Add the filter
    addFilter(filterType, filterField, filterValue, displayText);
    
    // Clear the input
    document.getElementById('filterValue').value = '';
}

// Add quick filter from buttons
function addQuickFilter(field, value) {
    const fieldLabels = {
        'game': 'Game',
        'rarity': 'Rarity', 
        'series': 'Series',
        'card_type': 'Type',
        'language': 'Language',
        'color': 'Color'
    };
    
    const displayText = `${fieldLabels[field]}: ${value}`;
    
    // Add as AND filter by default
    addFilter('and', field, value, displayText);
}

// Show advanced filters modal
function showAdvancedFilters() {
    const modal = new bootstrap.Modal(document.getElementById('advancedFiltersModal'));
    modal.show();
}

// Update the value dropdown based on selected field
function updateFilterValueDropdown(dropdownId, field) {
    const dropdown = document.getElementById(dropdownId);
    
    // Clear existing options
    dropdown.innerHTML = '<option value="">Select value...</option>';
    
    if (!field) return;
    
    // Fetch values from API
    fetch(`/api/filter-values/${field}`)
        .then(response => response.json())
        .then(values => {
            values.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                dropdown.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading filter values:', error);
        });
}

// Add advanced filter from modal
function addAdvancedFilter() {
    const type = document.getElementById('advancedFilterType').value;
    const field = document.getElementById('advancedFilterField').value;
    const value = document.getElementById('advancedFilterValue').value;
    
    if (!field || !value) {
        alert('Please select both a field and a value');
        return;
    }
    
    const fieldLabels = {
        'series': 'Anime',
        'color': 'Color',
        'rarity': 'Rarity', 
        'card_type': 'Card Type',
        'cost_2': 'Required Energy',
        'affinities': 'Affinities',
        'language': 'Language'
    };
    
    let displayText;
    if (type === 'not') {
        displayText = `NOT ${fieldLabels[field]}: ${value}`;
    } else {
        displayText = `${fieldLabels[field]}: ${value}`;
    }
    
    addFilter(type, field, value, displayText);
    
    // Reset the value dropdown
    document.getElementById('advancedFilterValue').value = '';
}

// Update main filters based on selected game
function updateMainFiltersForGame(game) {
    // Clear existing main filter dropdowns
    document.getElementById('animeFilter').innerHTML = '<option value="">All Anime</option>';
    document.getElementById('colorFilter').innerHTML = '<option value="">All Colors</option>';
    
    // Remove existing filters that are game-specific
    activeFilters.and = activeFilters.and.filter(f => f.field !== 'series' && f.field !== 'color');
    
    // Update filter labels and populate dropdowns based on game
    if (game === 'Union Arena') {
        document.querySelector('label[for="animeFilter"]').textContent = 'Anime';
        document.querySelector('label[for="colorFilter"]').textContent = 'Color';
        populateAnimeDropdown();
        populateColorDropdown();
    } else if (game === 'Pokemon') {
        document.querySelector('label[for="animeFilter"]').textContent = 'Type';
        document.querySelector('label[for="colorFilter"]').textContent = 'Stage';
        // For Pokemon, we would populate with Type and Stage values
        // But since we haven't scraped Pokemon yet, we'll leave them empty
    } else {
        // Hide main filters for unknown games
        document.querySelector('label[for="animeFilter"]').textContent = 'Filter 1';
        document.querySelector('label[for="colorFilter"]').textContent = 'Filter 2';
    }
    
    updateFilterDisplay();
}

// Card modal functions
function showCardModal(card) {
    // Find the index of this card in current search results
    currentCardIndex = currentSearchResults.findIndex(c => c.card_url === card.card_url);
    
    // Populate modal with card data
    document.getElementById('modalCardName').textContent = card.name;
    document.getElementById('modalCardImage').src = card.image_url;
    document.getElementById('modalCardImage').alt = card.name;
    document.getElementById('modalCardUrl').href = card.card_url;
    
    // Dynamically populate metadata fields based on what the card has
    populateDynamicMetadata(card);
    
    // Populate card text/effect
    document.getElementById('modalCardText').textContent = card.card_text || 'No effect text available.';
    
    // Update navigation buttons
    updateNavigationButtons();
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('cardModal'));
    modal.show();
    
    // Clean up any extra backdrops when modal is hidden
    document.getElementById('cardModal').addEventListener('hidden.bs.modal', function() {
        // Remove any extra backdrop elements
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Reset body class
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
    });
}

// Navigate between cards in the modal
function navigateCard(direction) {
    const newIndex = currentCardIndex + direction;
    
    if (newIndex >= 0 && newIndex < currentSearchResults.length) {
        currentCardIndex = newIndex;
        const card = currentSearchResults[currentCardIndex];
        
        // Update the modal content without reopening it
        updateModalContent(card);
    }
}

// Update modal content without reopening the modal
function updateModalContent(card) {
    // Populate modal with card data
    document.getElementById('modalCardName').textContent = card.name;
    document.getElementById('modalCardImage').src = card.image_url;
    document.getElementById('modalCardImage').alt = card.name;
    document.getElementById('modalCardUrl').href = card.card_url;
    
    // Dynamically populate metadata fields based on what the card has
    populateDynamicMetadata(card);
    
    // Populate card text/effect
    document.getElementById('modalCardText').textContent = card.card_text || 'No effect text available.';
    
    // Update navigation buttons
    updateNavigationButtons();
}

// Update navigation button states
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevCardBtn');
    const nextBtn = document.getElementById('nextCardBtn');
    
    // Hide buttons if there's only one card or no cards
    if (currentSearchResults.length <= 1) {
        prevBtn.style.display = 'none';
        nextBtn.style.display = 'none';
        return;
    }
    
    // Show buttons if there are multiple cards
    prevBtn.style.display = 'inline-block';
    nextBtn.style.display = 'inline-block';
    
    // Disable buttons at the edges
    prevBtn.disabled = currentCardIndex <= 0;
    nextBtn.disabled = currentCardIndex >= currentSearchResults.length - 1;
}

// Populate dynamic metadata fields
function populateDynamicMetadata(card) {
    const metadataContainer = document.getElementById('modalCardMetadata');
    metadataContainer.innerHTML = '';
    
    // Define field mappings with display names
    const fieldMappings = {
        'rarity': 'Rarity',
        'card_number': 'Number',
        'series': 'Series Name',
        'card_type': 'Card Type',
        'color': 'Activation Energy',
        'cost_2': 'Required Energy',
        'cost_1': 'Action Point Cost',
        'battle_points': 'Battle Point (BP)',
        'special_ability': 'Trigger',
        'affinities': 'Affinities',
        'generated_energy': 'Generated Energy',
        'price': 'TCGP Price'
    };
    
    // Only show fields that have values
    Object.entries(fieldMappings).forEach(([field, displayName]) => {
        const value = card[field];
        if (value && value !== '-' && value.trim() !== '') {
            const fieldHtml = `
                <div class="col-md-6">
                    <div class="card border-0 bg-light">
                        <div class="card-body p-3">
                            <h6 class="card-title text-muted mb-1">${displayName}</h6>
                            <p class="card-text fw-bold mb-0 ${field === 'price' ? 'text-success' : ''}">${value}</p>
                        </div>
                    </div>
                </div>
            `;
            metadataContainer.innerHTML += fieldHtml;
        }
    });
}
</script>
{% endblock %}