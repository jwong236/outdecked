{% extends "base.html" %}

{% block title %}Card Scraping - OutDecked Admin{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-primary mb-3">
            <i class="fas fa-download me-3"></i>Card Scraping
        </h1>
        <p class="lead text-muted">Scrape new cards from TCGPlayer to update your database</p>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column: Scraping Form, Status, and Console -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Scraping Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form id="scrapingForm">
                        <div class="mb-3">
                            <label for="gameName" class="form-label">Game Name</label>
                            <select class="form-select" id="gameName" name="game_name" required>
                                <option value="">Select a game...</option>
                                <option value="Pokemon">Pokemon</option>
                                <option value="Union Arena">Union Arena</option>
                            </select>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="startPage" class="form-label">Start Page</label>
                                <input type="number" class="form-control" id="startPage" name="start_page" min="1" value="1">
                            </div>
                            <div class="col-md-6">
                                <label for="endPage" class="form-label">End Page</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="endPage" name="end_page" min="1" placeholder="Enter page #">
                                    <div class="input-group-text">
                                        <input type="checkbox" class="form-check-input" id="infiniteEndPage" checked>
                                        <label class="form-check-label ms-1" for="infiniteEndPage">∞</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-text">Scraping will start from the start page. If infinite is checked, it will continue until no more cards are found. Otherwise, it will stop at the specified end page.</div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-play me-2"></i>Start Scraping
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Success Alert -->
            <div class="alert alert-success alert-dismissible fade show" id="successAlert" style="display: none;">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Scraping Status Panel -->
            <div class="card mb-4" id="scrapingStatus" style="display: none;">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-sync-alt me-2"></i>
                        Scraping Status
                    </h6>
                    <button class="btn btn-danger btn-sm" id="stopScrapingBtn">
                        <i class="fas fa-stop me-2"></i>
                        Stop Scraping
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary mb-1" id="currentPage">-</h4>
                                <small class="text-muted">Current Page</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success mb-1" id="endPageStatus">-</h4>
                                <small class="text-muted">End Page</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning mb-1" id="cardsFound">-</h4>
                                <small class="text-muted">Cards Found</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info mb-1" id="gameNameStatus">-</h4>
                                <small class="text-muted">Game</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Console Logs Panel -->
            <div class="card mb-4" id="consoleLogsPanel" style="display: none;">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-terminal me-2"></i>
                        Console Logs
                    </h6>
                    <div>
                        <button class="btn btn-outline-light btn-sm me-2" id="clearLogsBtn">
                            <i class="fas fa-trash me-1"></i>Clear
                        </button>
                        <button class="btn btn-outline-light btn-sm" id="toggleLogsBtn">
                            <i class="fas fa-chevron-up me-1"></i>Collapse
                        </button>
                    </div>
                </div>
                <div class="card-body" id="consoleLogs" style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace;">
                    <div class="console-line">Console ready...</div>
                </div>
            </div>
        </div>

        <!-- Right Column: Database Stats & Game Statistics -->
        <div class="col-lg-6">
            <!-- Database Stats Card -->
            <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                <div class="card-body text-center text-white" id="databaseStatsContent">
                    <div class="spinner-border text-white" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0">Loading database stats...</p>
                </div>
            </div>

            <!-- Game Statistics Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Game Statistics
                    </h5>
                </div>
                <div class="card-body" id="gameStatsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading game statistics...</p>
                    </div>
                </div>
            </div>

            <!-- Important Notes Card -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Important Notes
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0 small">
                        <li><strong>Please ask Jacob before scraping</strong> - This process can take a long time and uses system resources</li>
                        <li><strong>If you see any bugs please screenshot and let Jacob know</strong> - Help improve the system</li>
                    </ul>
                </div>
            </div>

            <!-- Database Backup/Restore Card -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        Database Backup & Restore
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        Download your database to keep a backup, or upload a previous backup to restore your data.
                    </p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" id="downloadDbBtn">
                            <i class="fas fa-download me-2"></i>Download Database Backup
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="uploadDbBtn">
                            <i class="fas fa-upload me-2"></i>Upload Database Backup
                        </button>
                    </div>
                    <input type="file" id="databaseFileInput" accept=".db" style="display: none;">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let statusInterval;
    let socket;

    document.addEventListener('DOMContentLoaded', function() {
        setupWebSocket();
        setupFormHandlers();
        setupConsoleLogs();
        loadGameStats();
        loadDatabaseStats();
        checkScrapingStatus(); // Check if scraping is already running
    });

    function setupWebSocket() {
        // Connect to WebSocket
        socket = io();
        
        // Listen for scraping log messages
        socket.on('scraping_log', function(logEntry) {
            addConsoleLog(`[${logEntry.timestamp}] ${logEntry.message}`, logEntry.type);
        });
        
        // Listen for real-time stats updates
        socket.on('stats_update', function(data) {
            updateStatsDisplay(data);
        });
        
        // Listen for connection events
        socket.on('connect', function() {
            console.log('WebSocket connected');
        });
        
        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
        });
    }

    function setupFormHandlers() {
        const form = document.getElementById('scrapingForm');
        const infiniteCheckbox = document.getElementById('infiniteEndPage');
        const endPageInput = document.getElementById('endPage');

        // Handle infinite checkbox toggle
        infiniteCheckbox.addEventListener('change', function() {
            if (this.checked) {
                endPageInput.disabled = true;
                endPageInput.value = '';
            } else {
                endPageInput.disabled = false;
            }
        });

        // Initialize the end page input state
        if (infiniteCheckbox.checked) {
            endPageInput.disabled = true;
        }

        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            startScraping();
        });
    }

    function startScraping() {
        const formData = new FormData(document.getElementById('scrapingForm'));
        const infiniteEndPage = document.getElementById('infiniteEndPage').checked;
        const endPageValue = formData.get('end_page');
        
        const data = {
            game_name: formData.get('game_name'),
            start_page: parseInt(formData.get('start_page')) || 1,
            end_page: infiniteEndPage ? null : (parseInt(endPageValue) || null)
        };

        console.log('Starting scraping process...');
        addConsoleLog('Starting scraping process...', 'info');

        fetch('/scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.message) {
                console.log('Scraping started successfully');
                addConsoleLog('Scraping started successfully!', 'success');
                
                // Show success message
                const successAlert = document.getElementById('successAlert');
                const successMessage = document.getElementById('successMessage');
                successMessage.textContent = result.message;
                successAlert.style.display = 'block';

                // Start polling for status
                startStatusPolling();
            } else if (result.error) {
                console.error('Failed to start scraping:', result.error);
                addConsoleLog(`Error: ${result.error}`, 'error');
                
                // Show error message in the success alert (but styled as error)
                const successAlert = document.getElementById('successAlert');
                const successMessage = document.getElementById('successMessage');
                successMessage.textContent = result.error;
                successAlert.className = 'alert alert-danger alert-dismissible fade show';
                successAlert.style.display = 'block';
            } else {
                console.error('Unknown response:', result);
                addConsoleLog('Unknown error occurred', 'error');
                alert('Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error starting scraping:', error);
            addConsoleLog(`Error: ${error.message}`, 'error');
            alert('Error starting scraping: ' + error.message);
        });
    }

    function checkScrapingStatus() {
        // Check if scraping is already running when page loads
        fetch('/api/scraping-status')
            .then(response => response.json())
            .then(status => {
                if (status.is_running) {
                    // Show status and console components
                    document.getElementById('scrapingStatus').style.display = 'block';
                    document.getElementById('consoleLogsPanel').style.display = 'block';
                    
                    // Update status display
                    updateScrapingStatus(status);
                    
                    // Start polling for updates
                    startStatusPolling();
                    
                    // Add a log message
                    addConsoleLog('Resumed monitoring existing scraping process...', 'info');
                }
            })
            .catch(error => {
                console.error('Error checking scraping status:', error);
            });
    }

    function startStatusPolling() {
        statusInterval = setInterval(pollScrapingStatus, 2000);
    }

    function pollScrapingStatus() {
        fetch('/api/scraping-status')
            .then(response => response.json())
            .then(status => {
                updateScrapingStatus(status);
                
                if (!status.is_running) {
                    clearInterval(statusInterval);
                    addConsoleLog('Scraping completed or stopped.', 'info');
                    // Keep status visible by not hiding the status card
                    // Just update the status to show it's stopped
                }
            })
            .catch(error => {
                console.error('Error polling status:', error);
                addConsoleLog(`Status polling error: ${error.message}`, 'error');
            });
    }

    function updateScrapingStatus(status) {
        const statusCard = document.getElementById('scrapingStatus');
        const consoleLogsCard = document.getElementById('consoleLogsPanel');
        
        // Always keep status and console logs visible
        statusCard.style.display = 'block';
        consoleLogsCard.style.display = 'block';
        
        if (status.is_running) {
            document.getElementById('currentPage').textContent = status.current_page || '-';
            document.getElementById('endPageStatus').textContent = status.end_page || '∞';
            document.getElementById('cardsFound').textContent = status.cards_found || '0';
            document.getElementById('gameNameStatus').textContent = status.game_name || '-';
            
            // Update progress bar based on infinite vs finite scraping
            const progressBar = document.getElementById('progressBar');
            if (status.end_page && status.end_page !== '∞' && status.current_page) {
                // Finite scraping - use end page
                const progress = (status.current_page / status.end_page) * 100;
                progressBar.style.width = Math.min(progress, 100) + '%';
                progressBar.textContent = Math.round(Math.min(progress, 100)) + '%';
            } else if (status.end_page === '∞' && status.current_page) {
                // Infinite scraping - get max pages from game stats
                getMaxPagesForProgress(status.game_name, status.current_page, progressBar);
            } else {
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
            }
        } else {
            // Show final status when stopped
            document.getElementById('currentPage').textContent = status.current_page || '-';
            document.getElementById('endPageStatus').textContent = status.end_page || '∞';
            document.getElementById('cardsFound').textContent = status.cards_found || '0';
            document.getElementById('gameNameStatus').textContent = status.game_name || '-';
            
            // Update progress bar to 100% when stopped
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
        }
    }

    function updateStatsDisplay(data) {
        // Update total cards count
        if (data.total_cards !== undefined) {
            const totalCardsElement = document.querySelector('[data-stat="total_cards"]');
            if (totalCardsElement) {
                totalCardsElement.textContent = data.total_cards.toLocaleString();
            }
        }
        
        // Update game-specific stats
        if (data.game_stats) {
            Object.entries(data.game_stats).forEach(([game, count]) => {
                const gameStatElement = document.querySelector(`[data-stat="game_${game}"]`);
                if (gameStatElement) {
                    gameStatElement.textContent = count.toLocaleString();
                }
            });
        }
    }

    function getMaxPagesForProgress(gameName, currentPage, progressBar) {
        // Get max pages from game stats for progress calculation
        fetch('/api/game-stats')
            .then(response => response.json())
            .then(data => {
                const gameStats = data.find(game => game.game_name === gameName);
                if (gameStats && gameStats.max_pages_found) {
                    const maxPages = gameStats.max_pages_found;
                    const progress = (currentPage / maxPages) * 100;
                    progressBar.style.width = Math.min(progress, 100) + '%';
                    progressBar.textContent = Math.round(Math.min(progress, 100)) + '%';
                } else {
                    // No max pages found yet, show 0%
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                }
            })
            .catch(error => {
                console.error('Error getting max pages for progress:', error);
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
            });
    }

    function stopScraping() {
        if (confirm('Are you sure you want to stop the scraping process?')) {
            const stopBtn = document.getElementById('stopScrapingBtn');
            const originalText = stopBtn.innerHTML;
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Stopping...';
            stopBtn.disabled = true;

            addConsoleLog('Stop signal sent...', 'warning');

            fetch('/api/stop-scraping', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                if (result.message) {
                    addConsoleLog('Scraping stopped successfully.', 'info');
                } else {
                    addConsoleLog(`Error stopping: ${result.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error stopping scraping:', error);
                addConsoleLog(`Error: ${error.message}`, 'error');
            })
            .finally(() => {
                setTimeout(() => {
                    stopBtn.innerHTML = originalText;
                    stopBtn.disabled = false;
                }, 3000);
            });
        }
    }

    function loadDatabaseStats() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                const statsContent = document.getElementById('databaseStatsContent');
                let html = `
                    <h1 class="display-4 fw-bold mb-2" data-stat="total_cards">${data.total_cards || '0'}</h1>
                    <h5 class="mb-0">Total Cards</h5>
                `;
                statsContent.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading database stats:', error);
                document.getElementById('databaseStatsContent').innerHTML = '<p class="text-white">Error loading stats</p>';
            });
    }

    function loadGameStats() {
        fetch('/api/game-stats')
            .then(response => response.json())
            .then(data => {
                const statsContent = document.getElementById('gameStatsContent');
                let html = '';
                
                if (data && data.length > 0) {
                    data.forEach(game => {
                        html += `
                            <div class="mb-3">
                                <h6 class="text-success">${game.game_name}</h6>
                                <p class="mb-1"><strong>Cards:</strong> <span data-stat="game_${game.game_name}">${game.card_count}</span></p>
                                <p class="mb-0"><strong>Max Pages:</strong> ${game.max_pages_found}</p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p class="text-muted">No game data available</p>';
                }
                
                statsContent.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading game stats:', error);
                document.getElementById('gameStatsContent').innerHTML = '<p class="text-danger">Error loading stats</p>';
            });
    }

    function setupConsoleLogs() {
        const clearBtn = document.getElementById('clearLogsBtn');
        const toggleBtn = document.getElementById('toggleLogsBtn');
        const logsContainer = document.getElementById('consoleLogs');

        clearBtn.addEventListener('click', function() {
            logsContainer.innerHTML = '<div class="console-line">Console cleared...</div>';
        });

        toggleBtn.addEventListener('click', function() {
            const isCollapsed = logsContainer.style.maxHeight === '0px';
            if (isCollapsed) {
                logsContainer.style.maxHeight = '300px';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Collapse';
            } else {
                logsContainer.style.maxHeight = '0px';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Expand';
            }
        });

        // Override console methods to show in UI
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addConsoleLog(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addConsoleLog(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addConsoleLog(args.join(' '), 'warning');
        };
    }

    function addConsoleLog(message, type = 'info') {
        const logsContainer = document.getElementById('consoleLogs');
        const timestamp = new Date().toLocaleTimeString();
        const typeClass = type === 'error' ? 'text-danger' : 
                         type === 'warning' ? 'text-warning' : 
                         type === 'success' ? 'text-success' : 'text-light';
        
        const logLine = document.createElement('div');
        logLine.className = `console-line ${typeClass}`;
        logLine.textContent = `[${timestamp}] ${message}`;
        
        logsContainer.appendChild(logLine);
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }

    // Set up stop button
    document.getElementById('stopScrapingBtn').addEventListener('click', stopScraping);

    // Database backup/restore functionality
    document.getElementById('downloadDbBtn').addEventListener('click', function() {
        addConsoleLog('Starting database backup download...', 'info');
        
        fetch('/api/backup-database')
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to download database');
                    });
                }
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `outdecked_backup_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.db`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                addConsoleLog('Database backup downloaded successfully!', 'success');
            })
            .catch(error => {
                console.error('Error downloading database:', error);
                addConsoleLog(`Error: ${error.message}`, 'error');
            });
    });

    document.getElementById('uploadDbBtn').addEventListener('click', function() {
        document.getElementById('databaseFileInput').click();
    });

    document.getElementById('databaseFileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.name.endsWith('.db')) {
            addConsoleLog('Error: Please select a .db file', 'error');
            event.target.value = '';
            return;
        }

        // Check if scraping is currently running
        fetch('/api/scraping-status')
        .then(response => response.json())
        .then(status => {
            if (status.is_running) {
                addConsoleLog('Error: Cannot restore database while scraping is running. Please stop scraping first.', 'error');
                event.target.value = '';
                return;
            }

            // Show confirmation popup
            const confirmed = confirm(
                'WARNING: This will permanently delete the current database and replace it with the uploaded file.\n\n' +
                'This action cannot be undone. Are you sure you want to continue?'
            );
            
            if (!confirmed) {
                // Reset the file input
                event.target.value = '';
                return;
            }

            addConsoleLog(`Uploading database backup: ${file.name}...`, 'info');

            const formData = new FormData();
            formData.append('database_file', file);

            fetch('/api/restore-database', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.message) {
                    addConsoleLog('Database restored successfully!', 'success');
                    // Reload the page to refresh stats
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else if (result.error) {
                    addConsoleLog(`Error: ${result.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error restoring database:', error);
                addConsoleLog(`Error: ${error.message}`, 'error');
            });

            // Clear the file input
            event.target.value = '';
        })
        .catch(error => {
            console.error('Error checking scraping status:', error);
            addConsoleLog('Error: Could not check scraping status', 'error');
            event.target.value = '';
        });
    });
</script>
{% endblock %}
