{% extends "base.html" %}

{% block title %}Card Scraping - TopDeck Admin{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="display-5 fw-bold text-primary mb-3">
            <i class="fas fa-download me-3"></i>Card Scraping
        </h1>
        <p class="lead text-muted">Scrape new cards from TCGPlayer to update your database</p>
    </div>

    <!-- Main Content Row -->
    <div class="row">
        <!-- Left Column: Scraping Form, Status, and Console -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Scraping Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <form id="scrapingForm">
                        <div class="mb-3">
                            <label for="gameName" class="form-label">Game Name</label>
                            <select class="form-select" id="gameName" name="game_name" required>
                                <option value="">Select a game...</option>
                                <option value="Pokemon">Pokemon</option>
                                <option value="Union Arena">Union Arena</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Scraping Mode</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scrape_mode" id="scrapeAll" value="all" checked>
                                <label class="form-check-label" for="scrapeAll">
                                    Scrape from page 1 to the end
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="scrape_mode" id="scrapeRange" value="range">
                                <label class="form-check-label" for="scrapeRange">
                                    Scrape specific page range
                                </label>
                            </div>
                        </div>
                        
                        <div class="row g-3" id="pageRange" style="display: none;">
                            <div class="col-md-6">
                                <label for="startPage" class="form-label">Start Page</label>
                                <input type="number" class="form-control" id="startPage" name="start_page" min="1" value="1">
                            </div>
                            <div class="col-md-6">
                                <label for="endPage" class="form-label">End Page</label>
                                <input type="number" class="form-control" id="endPage" name="end_page" min="1" value="10">
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg w-100">
                                <i class="fas fa-play me-2"></i>Start Scraping
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Success Alert -->
            <div class="alert alert-success alert-dismissible fade show" id="successAlert" style="display: none;">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>

            <!-- Scraping Status Panel -->
            <div class="card mb-4" id="scrapingStatus" style="display: none;">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-sync-alt me-2"></i>
                        Scraping Status
                    </h6>
                    <button class="btn btn-danger btn-sm" id="stopScrapingBtn">
                        <i class="fas fa-stop me-2"></i>
                        Stop Scraping
                    </button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-primary mb-1" id="currentPage">-</h4>
                                <small class="text-muted">Current Page</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success mb-1" id="totalPages">-</h4>
                                <small class="text-muted">Total Pages</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning mb-1" id="cardsFound">-</h4>
                                <small class="text-muted">Cards Found</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info mb-1" id="gameNameStatus">-</h4>
                                <small class="text-muted">Game</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Console Logs Panel -->
            <div class="card mb-4" id="consoleLogsPanel" style="display: none;">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-terminal me-2"></i>
                        Console Logs
                    </h6>
                    <div>
                        <button class="btn btn-outline-light btn-sm me-2" id="clearLogsBtn">
                            <i class="fas fa-trash me-1"></i>Clear
                        </button>
                        <button class="btn btn-outline-light btn-sm" id="toggleLogsBtn">
                            <i class="fas fa-chevron-up me-1"></i>Collapse
                        </button>
                    </div>
                </div>
                <div class="card-body" id="consoleLogs" style="max-height: 300px; overflow-y: auto; background-color: #1e1e1e; color: #00ff00; font-family: 'Courier New', monospace;">
                    <div class="console-line">Console ready...</div>
                </div>
            </div>
        </div>

        <!-- Right Column: Database Stats & Game Statistics -->
        <div class="col-lg-6">
            <!-- Database Stats Card -->
            <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                <div class="card-body text-center text-white" id="databaseStatsContent">
                    <div class="spinner-border text-white" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0">Loading database stats...</p>
                </div>
            </div>

            <!-- Game Statistics Card -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Game Statistics
                    </h5>
                </div>
                <div class="card-body" id="gameStatsContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading game statistics...</p>
                    </div>
                </div>
            </div>

            <!-- Important Notes Card -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Important Notes
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0 small">
                        <li><strong>Please ask Jacob before scraping</strong> - This process can take a long time and uses system resources</li>
                        <li><strong>If you see any bugs please screenshot and let Jacob know</strong> - Help improve the system</li>
                        <li><strong>Scraping respects robots.txt</strong> - 10 second delay between pages to be respectful</li>
                        <li><strong>Stop button may take a moment</strong> - The system needs to finish current page processing</li>
                        <li><strong>Database updates automatically</strong> - New cards are saved as they're found</li>
                    </ul>
                </div>
            </div>

            <!-- Database Backup/Restore Card -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        Database Backup & Restore
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-3">
                        Download your database to keep a backup, or upload a previous backup to restore your data.
                    </p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" id="downloadDbBtn">
                            <i class="fas fa-download me-2"></i>Download Database Backup
                        </button>
                        <button class="btn btn-outline-success btn-sm" id="uploadDbBtn">
                            <i class="fas fa-upload me-2"></i>Upload Database Backup
                        </button>
                    </div>
                    <input type="file" id="databaseFileInput" accept=".db" style="display: none;">
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let statusInterval;

    document.addEventListener('DOMContentLoaded', function() {
        setupFormHandlers();
        setupConsoleLogs();
        loadGameStats();
        loadDatabaseStats();
    });

    function setupFormHandlers() {
        const form = document.getElementById('scrapingForm');
        const scrapeModeRadios = document.querySelectorAll('input[name="scrape_mode"]');
        const pageRange = document.getElementById('pageRange');

        // Handle scrape mode changes
        scrapeModeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'range') {
                    pageRange.style.display = 'block';
                } else {
                    pageRange.style.display = 'none';
                }
            });
        });

        // Handle form submission
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            startScraping();
        });
    }

    function startScraping() {
        const formData = new FormData(document.getElementById('scrapingForm'));
        const data = Object.fromEntries(formData.entries());

        console.log('Starting scraping process...');
        addConsoleLog('Starting scraping process...', 'info');

        fetch('/scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.message) {
                console.log('Scraping started successfully');
                addConsoleLog('Scraping started successfully!', 'success');
                
                // Show success message
                const successAlert = document.getElementById('successAlert');
                const successMessage = document.getElementById('successMessage');
                successMessage.textContent = result.message;
                successAlert.style.display = 'block';

                // Start polling for status
                startStatusPolling();
            } else if (result.error) {
                console.error('Failed to start scraping:', result.error);
                addConsoleLog(`Error: ${result.error}`, 'error');
                
                // Show error message in the success alert (but styled as error)
                const successAlert = document.getElementById('successAlert');
                const successMessage = document.getElementById('successMessage');
                successMessage.textContent = result.error;
                successAlert.className = 'alert alert-danger alert-dismissible fade show';
                successAlert.style.display = 'block';
            } else {
                console.error('Unknown response:', result);
                addConsoleLog('Unknown error occurred', 'error');
                alert('Unknown error occurred');
            }
        })
        .catch(error => {
            console.error('Error starting scraping:', error);
            addConsoleLog(`Error: ${error.message}`, 'error');
            alert('Error starting scraping: ' + error.message);
        });
    }

    function startStatusPolling() {
        statusInterval = setInterval(pollScrapingStatus, 2000);
    }

    function pollScrapingStatus() {
        fetch('/api/scraping-status')
            .then(response => response.json())
            .then(status => {
                updateScrapingStatus(status);
                
                if (!status.is_running) {
                    clearInterval(statusInterval);
                    addConsoleLog('Scraping completed or stopped.', 'info');
                }
            })
            .catch(error => {
                console.error('Error polling status:', error);
                addConsoleLog(`Status polling error: ${error.message}`, 'error');
            });
    }

    function updateScrapingStatus(status) {
        const statusCard = document.getElementById('scrapingStatus');
        const consoleLogsCard = document.getElementById('consoleLogsPanel');
        
        if (status.is_running) {
            statusCard.style.display = 'block';
            consoleLogsCard.style.display = 'block';
            
            document.getElementById('currentPage').textContent = status.current_page || '-';
            document.getElementById('totalPages').textContent = status.total_pages || '-';
            document.getElementById('cardsFound').textContent = status.cards_found || '0';
            document.getElementById('gameNameStatus').textContent = status.game_name || '-';
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            if (status.total_pages && status.current_page) {
                const progress = (status.current_page / status.total_pages) * 100;
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';
            }
        } else {
            statusCard.style.display = 'none';
            consoleLogsCard.style.display = 'none';
        }
    }

    function stopScraping() {
        if (confirm('Are you sure you want to stop the scraping process?')) {
            const stopBtn = document.getElementById('stopScrapingBtn');
            const originalText = stopBtn.innerHTML;
            stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Stopping...';
            stopBtn.disabled = true;

            addConsoleLog('Stop signal sent...', 'warning');

            fetch('/api/stop-scraping', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                if (result.message) {
                    addConsoleLog('Scraping stopped successfully.', 'info');
                } else {
                    addConsoleLog(`Error stopping: ${result.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error stopping scraping:', error);
                addConsoleLog(`Error: ${error.message}`, 'error');
            })
            .finally(() => {
                setTimeout(() => {
                    stopBtn.innerHTML = originalText;
                    stopBtn.disabled = false;
                }, 3000);
            });
        }
    }

    function loadDatabaseStats() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                const statsContent = document.getElementById('databaseStatsContent');
                let html = `
                    <h1 class="display-4 fw-bold mb-2">${data.total_cards || '0'}</h1>
                    <h5 class="mb-0">Total Cards</h5>
                `;
                statsContent.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading database stats:', error);
                document.getElementById('databaseStatsContent').innerHTML = '<p class="text-white">Error loading stats</p>';
            });
    }

    function loadGameStats() {
        fetch('/api/game-stats')
            .then(response => response.json())
            .then(data => {
                const statsContent = document.getElementById('gameStatsContent');
                let html = '';
                
                if (data && data.length > 0) {
                    data.forEach(game => {
                        html += `
                            <div class="mb-3">
                                <h6 class="text-success">${game.game_name}</h6>
                                <p class="mb-1"><strong>Cards:</strong> ${game.card_count}</p>
                                <p class="mb-0"><strong>Max Pages:</strong> ${game.max_pages_found}</p>
                            </div>
                        `;
                    });
                } else {
                    html = '<p class="text-muted">No game data available</p>';
                }
                
                statsContent.innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading game stats:', error);
                document.getElementById('gameStatsContent').innerHTML = '<p class="text-danger">Error loading stats</p>';
            });
    }

    function setupConsoleLogs() {
        const clearBtn = document.getElementById('clearLogsBtn');
        const toggleBtn = document.getElementById('toggleLogsBtn');
        const logsContainer = document.getElementById('consoleLogs');

        clearBtn.addEventListener('click', function() {
            logsContainer.innerHTML = '<div class="console-line">Console cleared...</div>';
        });

        toggleBtn.addEventListener('click', function() {
            const isCollapsed = logsContainer.style.maxHeight === '0px';
            if (isCollapsed) {
                logsContainer.style.maxHeight = '300px';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-up me-1"></i>Collapse';
            } else {
                logsContainer.style.maxHeight = '0px';
                toggleBtn.innerHTML = '<i class="fas fa-chevron-down me-1"></i>Expand';
            }
        });

        // Override console methods to show in UI
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addConsoleLog(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addConsoleLog(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addConsoleLog(args.join(' '), 'warning');
        };
    }

    function addConsoleLog(message, type = 'info') {
        const logsContainer = document.getElementById('consoleLogs');
        const timestamp = new Date().toLocaleTimeString();
        const typeClass = type === 'error' ? 'text-danger' : 
                         type === 'warning' ? 'text-warning' : 
                         type === 'success' ? 'text-success' : 'text-light';
        
        const logLine = document.createElement('div');
        logLine.className = `console-line ${typeClass}`;
        logLine.textContent = `[${timestamp}] ${message}`;
        
        logsContainer.appendChild(logLine);
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }

    // Set up stop button
    document.getElementById('stopScrapingBtn').addEventListener('click', stopScraping);

    // Database backup/restore functionality
    document.getElementById('downloadDbBtn').addEventListener('click', function() {
        addConsoleLog('Starting database backup download...', 'info');
        
        fetch('/api/backup-database')
            .then(response => {
                if (response.ok) {
                    return response.blob();
                } else {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Failed to download database');
                    });
                }
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `topdeck_backup_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.db`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                addConsoleLog('Database backup downloaded successfully!', 'success');
            })
            .catch(error => {
                console.error('Error downloading database:', error);
                addConsoleLog(`Error: ${error.message}`, 'error');
            });
    });

    document.getElementById('uploadDbBtn').addEventListener('click', function() {
        document.getElementById('databaseFileInput').click();
    });

    document.getElementById('databaseFileInput').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.name.endsWith('.db')) {
            addConsoleLog('Error: Please select a .db file', 'error');
            return;
        }

        addConsoleLog(`Uploading database backup: ${file.name}...`, 'info');

        const formData = new FormData();
        formData.append('database_file', file);

        fetch('/api/restore-database', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.message) {
                addConsoleLog('Database restored successfully!', 'success');
                // Reload the page to refresh stats
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else if (result.error) {
                addConsoleLog(`Error: ${result.error}`, 'error');
            }
        })
        .catch(error => {
            console.error('Error restoring database:', error);
            addConsoleLog(`Error: ${error.message}`, 'error');
        });

        // Clear the file input
        event.target.value = '';
    });
</script>
{% endblock %}
